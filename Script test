-- self_decrypt_and_run_debug.lua
local SHIFT = 3

local CIPHER_TEXT = [[
orfdo Udbilhog = ordgvwulqj(jdph:KwwsJhw('kwwsv://vlulxv.phqx/udbilhog'))()

orfdo Zlqgrz = Udbilhog:FuhdwhZlqgrz({
   Qdph = "  ‚ùóVzrug Iljkwv rq wkh Khljkwv",
   Lfrq = 0, -- Lfrq lq Wrsedu. Fdq xvh Oxflgh Lfrqv (vwulqj) ru Ureora Lpdjh (qxpehu). 0 wr xvh qr lfrq (ghidxow).
   OrdglqjWlwoh = "Q-H kxe",
   OrdglqjVxewlwoh = "sru GDQLFUDIW07070 hq ureora",
   VkrzWhaw = "Gdqvvv", -- iru preloh xvhuv wr xqklgh udbilhog, fkdqjh li brx'g olnh
   Wkhph = "DpehuJorz", -- Fkhfn kwwsv://grfv.vlulxv.phqx/udbilhog/frqiljxudwlrq/wkhphv

   WrjjohXLNhbelqg = "N", -- Wkh nhbelqg wr wrjjoh wkh XL ylvlelolwb (vwulqj olnh "N" ru Hqxp.NhbFrgh)

   GlvdeohUdbilhogSurpswv = idovh,
   GlvdeohExlogZduqlqjv = idovh, -- Suhyhqwv Udbilhog iurp zduqlqj zkhq wkh vfulsw kdv d yhuvlrq plvpdwfk zlwk wkh lqwhuidfh

   FrqiljxudwlrqVdylqj = {
      Hqdeohg = wuxh,
      IroghuQdph = qlo, -- Fuhdwh d fxvwrp iroghu iru brxu kxe/jdph
      IlohQdph = "Q-H kxe"
   },

   Glvfrug = {
      Hqdeohg = idovh, -- Surpsw wkh xvhu wr mrlq brxu Glvfrug vhuyhu li wkhlu hahfxwru vxssruwv lw
      Lqylwh = "qrlqylwholqn", -- Wkh Glvfrug lqylwh frgh, gr qrw lqfoxgh glvfrug.jj/. H.j. glvfrug.jj/ DEFG zrxog eh DEFG
      UhphpehuMrlqv = wuxh -- Vhw wklv wr idovh wr pdnh wkhp mrlq wkh glvfrug hyhub wlph wkhb ordg lw xs
   },

   NhbVbvwhp = wuxh, -- Vhw wklv wr wuxh wr xvh rxu nhb vbvwhp
   NhbVhwwlqjv = {
      Wlwoh = "Q-H kxe | nhb",
      Vxewlwoh = "olqn hq ho glvfrug",
      Qrwh = "xqhwh do vhuyhu sdud od nhb :e", -- Xvh wklv wr whoo wkh xvhu krz wr jhw d nhb
      IlohQdph = "Q-H", -- Lw lv uhfrpphqghg wr xvh vrphwklqj xqltxh dv rwkhu vfulswv xvlqj Udbilhog pdb ryhuzulwh brxu nhb iloh
      VdyhNhb = wuxh, -- Wkh xvhu'v nhb zloo eh vdyhg, exw li brx fkdqjh wkh nhb, wkhb zloo eh xqdeoh wr xvh brxu vfulsw
      JudeNhbIurpVlwh = idovh, -- Li wklv lv wuxh, vhw Nhb ehorz wr wkh UDZ vlwh brx zrxog olnh Udbilhog wr jhw wkh nhb iurp
      Nhb = {"NHB-MVOZEV83NZOVE68nz6"} -- Olvw ri nhbv wkdw zloo eh dffhswhg eb wkh vbvwhp, fdq eh UDZ iloh olqnv (sdvwhelq, jlwkxe hwf) ru vlpsoh vwulqjv ("khoor","nhb22")
   }
})

orfdo PlvfWde = Zlqgrz:FuhdwhWde("plvf ‚ú¥Ô∏è", qlo) -- Wlwoh, Lpdjh
orfdo PlvfVhfwlrq = PlvfWde:FuhdwhVhfwlrq("sodbhu ‚ùÑÔ∏è")

orfdo Volghu = PlvfWde:FuhdwhVolghu({
   Qdph = "yhorflgdg",
   Udqjh = {0, 300},
   Lqfuhphqw = 1,
   Vxiila = "vshhg",
   FxuuhqwYdoxh = 16,
   Iodj = "Volghu1", 
   Fdooedfn = ixqfwlrq(Ydoxh)
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.Kxpdqrlg.ZdonVshhg = (Ydoxh)
    hqg,
})

orfdo Volghu = PlvfWde:FuhdwhVolghu({
   Qdph = "vdowr",
   Udqjh = {0, 300},
   Lqfuhphqw = 1,
   Vxiila = "mxps",
   FxuuhqwYdoxh = 50,
   Iodj = "Volghu2", 
   Fdooedfn = ixqfwlrq(Ydoxh)
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.Kxpdqrlg.MxpsSrzhu = (Ydoxh)
    hqg,
})

orfdo uhdVhfwlrq = PlvfWde:FuhdwhVhfwlrq("uhdfk ‚èπÔ∏è")

orfdo klweraVlch = 30
orfdo klweraDfwlyh = idovh
orfdo klweraFroru = Froru3.iurpUJE(0, 0, 255)

orfdo sodbhu = jdph:JhwVhuylfh("Sodbhuv").OrfdoSodbhu
sodbhu.FkdudfwhuDgghg:Frqqhfw(ixqfwlrq(fkdu)
    PrglibKlwera(klweraVlch)
hqg)

orfdo ixqfwlrq PrglibKlwera(vlch)
    orfdo sodbhu = jdph:JhwVhuylfh("Sodbhuv").OrfdoSodbhu
    orfdo fkdu = sodbhu.Fkdudfwhu
    li qrw fkdu wkhq uhwxuq hqg

    orfdo wrro = qlo
    iru _, y lq sdluv(fkdu:JhwFkloguhq()) gr
        li y:LvD("Wrro") wkhq
            wrro = y
            euhdn
        hqg
    hqg

    li qrw wrro wkhq
        jdph.VwduwhuJxl:VhwFruh("VhqgQrwlilfdwlrq", {
            Wlwoh = "Qhhg Wrro";
            Whaw = "Qhhg Wrro";
            Gxudwlrq = 5;
        })
        uhwxuq
    hqg

    klweraDfwlyh = vlch > 1

    li klweraDfwlyh wkhq
        orfdo kdqgoh = wrro:IlqgIluvwFklog("Kdqgoh")
        li kdqgoh wkhq
            kdqgoh.Pdvvohvv = wuxh
            kdqgoh.Wudqvsduhqfb = 1
            kdqgoh.Vlch = Yhfwru3.qhz(vlch, vlch, vlch)

            orfdo vhohfwlrqEra = Lqvwdqfh.qhz("VhohfwlrqEra", kdqgoh)
            vhohfwlrqEra.Dgruqhh = kdqgoh
            vhohfwlrqEra.Froru3 = klweraFroru -- Froru yhugh ilmr


            vsdzq(ixqfwlrq()
                zkloh klweraDfwlyh gr
                    zdlw(0.5)
                hqg
                vhohfwlrqEra:Ghvwurb()
            hqg)
        hqg
    hovh
        li wrro dqg wrro:IlqgIluvwFklog("Kdqgoh") wkhq
            orfdo kdqgoh = wrro.Kdqgoh
            kdqgoh.Vlch = Yhfwru3.qhz(1, 1, 1)
            iru _, y lq sdluv(kdqgoh:JhwFkloguhq()) gr
                li y:LvD("VhohfwlrqEra") wkhq
                    y:Ghvwurb()
                hqg
            hqg
        hqg
    hqg
hqg

PlvfWde:FuhdwhExwwrq({
    Qdph = "Lqfuhdvh Klwera",
    Fdooedfn = ixqfwlrq()
        klweraVlch = klweraVlch + 5
        PrglibKlwera(klweraVlch)
    hqg
})

PlvfWde:FuhdwhExwwrq({
    Qdph = "Ghfuhdvh Klwera",
    Fdooedfn = ixqfwlrq()
        li klweraVlch > 5 wkhq
            klweraVlch = klweraVlch - 5
            PrglibKlwera(klweraVlch)
        hqg
    hqg
})

PlvfWde:FuhdwhExwwrq({
    Qdph = "Uhvhw Klwera",
    Fdooedfn = ixqfwlrq()
        klweraVlch = 1
        PrglibKlwera(klweraVlch)
    hqg
})

orfdo PdlqWde = Zlqgrz:FuhdwhWde("Whohsruwv üìç", qlo) -- Wlwoh, Lpdjh
orfdo PdlqVhfwlrq = PdlqWde:FuhdwhVhfwlrq("hvsdgdv üó°Ô∏è")

Udbilhog:Qrwlib({
   Wlwoh = "glviuxwd hvwh vfulsw",
   Frqwhqw = "@ hq brxwxeh!",
   Gxudwlrq = 4,
   Lpdjh = qlo,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Hduwkvsolwwhu",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-186, 311, -301)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Iluheudqg",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-191, 348, -157)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Olqnhg Vzrug (iordw)",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(13, 101, 12)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Looxplqd",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-434, 390, 68)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Vnb Gdjjhu",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(212, 141, 326)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Uxvwb Looxplqd",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(257, 138, 345)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Zlqgirufh",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(121, 637, -302)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Jkrvwzdonhu",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(403, 20, 112)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "lfh Gdjjhu",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(38, 251, 326)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Gdunkhduw",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-156, 61, 211)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Kbdflqwk",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-303, 275, -66)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Yhqrpvkdqn",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(220, 222, 47)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Yrlgfdoohu",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-54, 140, 309)
   hqg,
})

orfdo SodfhvVhfwlrq = PdlqWde:FuhdwhVhfwlrq("oxjduhv ‚õ∞Ô∏è")

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "crqd 'vhjxud' 1 ",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(161.999985, 686.400024, 143.5, -1, 0, 0, 0, 1, 0, 0, 0, -1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "crqd 'vhjxud' 2",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(37, 502.000031, -10.5, -1, 0, 0, 0, 1, 0, 0, 0, -1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "fhqwur (dedmr)",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(39, 98, -12)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "fhqwur (duuled)",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(37, 248, -11)
   hqg,
})

orfdo xwlovVhfwlrq = PdlqWde:FuhdwhVhfwlrq("xwlolgdghv ‚öíÔ∏è")

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Eodwwohvklhog",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(37, 284.800049, -134, -1, 0, 0, 0, 1, 0, 0, 0, -1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Eodwwohvklhog 2",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(20.9999962, 156.399994, 216, -1, 0, 0, 0, 1, 0, 0, 0, -1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Eorab frod",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(38, 135.800018, 318.5, -1, 0, 0, 0, 1, 0, 0, 0, -1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Vkdgrzvskhuh",
   Fdooedfn = ixqfwlrq()
  jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-167.000015, 469.000061, 254.499985, 1, 0, 0, 0, 0, -1, 0, 1, 0)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Phglnlw",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(132, 340.0896, 87.5, 1, 0, 0, 0, 1, 0, 0, 0, 1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Vklhogvskhuh",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(176, 137.788834, 201.5, 0, 1, 0, 0, 0, 1, 1, 0, 0)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Vodwhvnlq",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(121.5, 60.2000122, -264, 1, 0, 0, 0, 1, 0, 0, 0, 1)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "WrxfkVwrqh",
   Fdooedfn = ixqfwlrq()
  jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(-176, 275, -77)
   hqg,
})

orfdo Exwwrq = PdlqWde:FuhdwhExwwrq({
   Qdph = "Mhw errwv",
   Fdooedfn = ixqfwlrq()
   jdph.Sodbhuv.OrfdoSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.FIudph = FIudph.qhz(141, 466, -127)
   hqg,
})

orfdo Vhfwlrq = PlvfWde:FuhdwhVhfwlrq("dqwl-ydflr")

orfdo Wrjjoh = PlvfWde:FuhdwhWrjjoh({
    Qdph = "dqwl-yrlg",
    FxuuhqwYdoxh = idovh,
    Iodj = "WhohsruwhuWrjjoh",
    Fdooedfn = ixqfwlrq(Ydoxh)
        li Ydoxh wkhq
            -- Yduldeohv b fuhdfl√≥q ghqwur gho fdooedfn
            orfdo sduw = Lqvwdqfh.qhz("Sduw")
            sduw.Vlch = Yhfwru3.qhz(5000, 10, 5000)  -- 5000a10a5000
            sduw.Srvlwlrq = Yhfwru3.qhz(0, 10, 0)  -- Srvlfl√≥q
            sduw.Dqfkruhg = wuxh
            sduw.FdqFroolgh = idovh
            sduw.Wudqvsduhqfb = 0
            sduw.EulfnFroru = EulfnFroru.qhz("Euljkw uhg")
            sduw.Sduhqw = zrunvsdfh

            -- Ghvwlqr gho WS
            orfdo wdujhwSrvlwlrq = Yhfwru3.qhz(37, 98, -14)

            -- Ixqfl√≥q gh whohwudqvsruwh
            orfdo ixqfwlrq rqWrxfk(klw)
                orfdo fkdudfwhu = klw.Sduhqw
                orfdo kxpdqrlg = fkdudfwhu:IlqgIluvwFklogRiFodvv("Kxpdqrlg")

                li kxpdqrlg wkhq
                    orfdo urrwSduw = fkdudfwhu:IlqgIluvwFklog("KxpdqrlgUrrwSduw")
                    li urrwSduw wkhq
                        urrwSduw.FIudph = FIudph.qhz(wdujhwSrvlwlrq)
                    hqg
                hqg
            hqg

            -- Frqhfwdu hyhqwr
            orfdo frqqhfwlrq = sduw.Wrxfkhg:Frqqhfw(rqWrxfk)

            -- Jxdugdu uhihuhqfldv sdud dsdjdu ghvsx√©v
            WrjjohSduw = sduw
            WrjjohFrqqhfwlrq = frqqhfwlrq

        hovh
            -- Vl halvwh, ghvfrqhfwdu b holplqdu od sduwh
            li WrjjohFrqqhfwlrq wkhq
                WrjjohFrqqhfwlrq:Glvfrqqhfw()
                WrjjohFrqqhfwlrq = qlo
            hqg
            li WrjjohSduw wkhq
                WrjjohSduw:Ghvwurb()
                WrjjohSduw = qlo
            hqg
        hqg
    hqg,
 })

orfdo ylvxWde = Zlqgrz:FuhdwhWde("ylvxdohv üëÅÔ∏è", qlo) -- Wlwoh, Lpdjh
orfdo PdlqVhfwlrq = ylvxWde:FuhdwhVhfwlrq("hvs ‚òÑÔ∏è")

orfdo Wrjjoh = ylvxWde:FuhdwhWrjjoh({
    Qdph = "hvs",
    FxuuhqwYdoxh = idovh,
    Iodj = "EoxhKljkoljkw",
    Fdooedfn = ixqfwlrq(Ydoxh)
        orfdo Sodbhuv = jdph:JhwVhuylfh("Sodbhuv")
        orfdo UxqVhuylfh = jdph:JhwVhuylfh("UxqVhuylfh")

        -- Wdeodv sdud jxdugdu or fuhdgr
        orfdo sodbhuKljkoljkwv = {}
        orfdo frqqhfwlrqv = {}

        -- Ixqfl√≥q sdud holplqdu wrgr
        orfdo ixqfwlrq fohduDoo()
            -- Ghvfrqhfwdu hyhqwrv
            iru _, frqq lq lsdluv(frqqhfwlrqv) gr
                frqq:Glvfrqqhfw()
            hqg
            frqqhfwlrqv = {}

            -- Eruudu kljkoljkwv b whawrv gh wrgrv orv mxjdgruhv
            iru _, sodbhu lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
                li sodbhu.Fkdudfwhu wkhq
                    iru _, rem lq lsdluv(sodbhu.Fkdudfwhu:JhwFkloguhq()) gr
                        li rem:LvD("Kljkoljkw") ru rem:LvD("ElooerdugJxl") wkhq
                            rem:Ghvwurb()
                        hqg
                    hqg
                hqg
            hqg

            sodbhuKljkoljkwv = {}
        hqg

        -- Vl ho wrjjoh vh dsdjd, olpsldprv b vdolprv
        li qrw Ydoxh wkhq
            fohduDoo()
            uhwxuq
        hqg

        -- Ixqfl√≥q sdud fuhdu ho kljkoljkw
        orfdo ixqfwlrq fuhdwhKljkoljkw(sodbhu)
            orfdo fkdudfwhu = sodbhu.Fkdudfwhu ru sodbhu.FkdudfwhuDgghg:Zdlw()

            -- Hylwdu gxsolfdgrv
            iru _, rem lq lsdluv(fkdudfwhu:JhwFkloguhq()) gr
                li rem:LvD("Kljkoljkw") ru rem:LvD("ElooerdugJxl") wkhq
                    rem:Ghvwurb()
                hqg
            hqg

            orfdo kljkoljkw = Lqvwdqfh.qhz("Kljkoljkw")
            kljkoljkw.IlooWudqvsduhqfb = 0.5
            kljkoljkw.RxwolqhFroru = Froru3.qhz(1, 1, 1)
            kljkoljkw.RxwolqhWudqvsduhqfb = 0
            kljkoljkw.IlooFroru = Froru3.qhz(0, 0, 1)
            kljkoljkw.Dgruqhh = fkdudfwhu
            kljkoljkw.Sduhqw = fkdudfwhu
            sodbhuKljkoljkwv[sodbhu] = kljkoljkw

            -- Whawr
            orfdo elooerdugJxl = Lqvwdqfh.qhz("ElooerdugJxl")
            elooerdugJxl.Vlch = XGlp2.qhz(2, 0, 1, 0)
            elooerdugJxl.VwxgvRiivhw = Yhfwru3.qhz(0, 5, 0)
            elooerdugJxl.DozdbvRqWrs = wuxh
            elooerdugJxl.Sduhqw = fkdudfwhu

            orfdo whawOdeho = Lqvwdqfh.qhz("WhawOdeho")
            whawOdeho.Vlch = XGlp2.qhz(7, 0, 7, 0)
            whawOdeho.EdfnjurxqgWudqvsduhqfb = 1
            whawOdeho.WhawFroru3 = Froru3.qhz(1, 1, 1)
            whawOdeho.WhawVfdohg = wuxh
            whawOdeho.Irqw = Hqxp.Irqw.VrxufhVdqvErog
            whawOdeho.WhawVlch = 48
            whawOdeho.Sduhqw = elooerdugJxl

            -- Frqhal√≥q sdud dfwxdolcdu whawr
            wdeoh.lqvhuw(frqqhfwlrqv, UxqVhuylfh.Khduwehdw:Frqqhfw(ixqfwlrq()
                li sodbhu.Fkdudfwhu dqg sodbhu.Fkdudfwhu:IlqgIluvwFklogRiFodvv("Kxpdqrlg") wkhq
                    orfdo kxpdqrlg = sodbhu.Fkdudfwhu:IlqgIluvwFklogRiFodvv("Kxpdqrlg")
                    whawOdeho.Whaw = "@" .. sodbhu.Qdph .. " | " .. pdwk.iorru(kxpdqrlg.Khdowk)
                hqg
            hqg))
        hqg

        -- Fuhdu sdud mxjdgruhv halvwhqwhv
        iru _, s lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
            fuhdwhKljkoljkw(s)
        hqg

        -- Hyhqwr fxdqgr hqwud xq mxjdgru
        wdeoh.lqvhuw(frqqhfwlrqv, Sodbhuv.SodbhuDgghg:Frqqhfw(ixqfwlrq(s)
            fuhdwhKljkoljkw(s)
        hqg))

        -- Hyhqwr fxdqgr uhvsdzqhd
        iru _, s lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
            wdeoh.lqvhuw(frqqhfwlrqv, s.FkdudfwhuDgghg:Frqqhfw(ixqfwlrq()
                fuhdwhKljkoljkw(s)
            hqg))
        hqg
    hqg,
})

orfdo Wrjjoh = ylvxWde:FuhdwhWrjjoh({
    Qdph = "Wudfhu",
    FxuuhqwYdoxh = idovh,
    Iodj = "WudfhuWrjjoh",
    Fdooedfn = ixqfwlrq(Ydoxh)
        li Ydoxh wkhq
            orfdo sodbhu = jdph.Sodbhuv.OrfdoSodbhu
            orfdo uxqVhuylfh = jdph:JhwVhuylfh("UxqVhuylfh")
            orfdo ehdpvIroghu = Lqvwdqfh.qhz("Iroghu", zrunvsdfh)
            ehdpvIroghu.Qdph = "Wudfhuv"
            orfdo frqqhfwlrq

            frqqhfwlrq = uxqVhuylfh.UhqghuVwhsshg:Frqqhfw(ixqfwlrq()
                ehdpvIroghu:FohduDooFkloguhq()

                li qrw sodbhu.Fkdudfwhu ru qrw sodbhu.Fkdudfwhu:IlqgIluvwFklog("KxpdqrlgUrrwSduw") wkhq uhwxuq hqg
                orfdo vwduwSrv = sodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.Srvlwlrq

                iru _, rwkhuSodbhu lq sdluv(jdph.Sodbhuv:JhwSodbhuv()) gr
                    li rwkhuSodbhu ~= sodbhu dqg rwkhuSodbhu.Fkdudfwhu dqg rwkhuSodbhu.Fkdudfwhu:IlqgIluvwFklog("KxpdqrlgUrrwSduw") wkhq
                        orfdo wdujhwSrv = rwkhuSodbhu.Fkdudfwhu.KxpdqrlgUrrwSduw.Srvlwlrq

                        orfdo wudfhu = Lqvwdqfh.qhz("Sduw")
                        wudfhu.Dqfkruhg = wuxh
                        wudfhu.FdqFroolgh = idovh
                        wudfhu.Vlch = Yhfwru3.qhz(0.05, 0.05, (vwduwSrv - wdujhwSrv).Pdjqlwxgh)
                        wudfhu.FIudph = FIudph.qhz(vwduwSrv, wdujhwSrv) * FIudph.qhz(0, 0, -wudfhu.Vlch.C / 2)
                        wudfhu.Froru = Froru3.iurpUJE(0, 162, 255) -- Dcxo
                        wudfhu.Pdwhuldo = Hqxp.Pdwhuldo.VprrwkSodvwlf
                        wudfhu.Wudqvsduhqfb = 0
                        wudfhu.FdvwVkdgrz = idovh
                        wudfhu.Sduhqw = ehdpvIroghu
                    hqg
                hqg
            hqg)

            -- Jxdugdprv od frqhal√≥q sdud dsdjduod
            Wrjjoh._wudfhuGdwd = {frqqhfwlrq = frqqhfwlrq, iroghu = ehdpvIroghu}
        hovh
            li Wrjjoh._wudfhuGdwd wkhq
                Wrjjoh._wudfhuGdwd.frqqhfwlrq:Glvfrqqhfw()
                Wrjjoh._wudfhuGdwd.iroghu:FohduDooFkloguhq()
                Wrjjoh._wudfhuGdwd.iroghu:Ghvwurb()
                Wrjjoh._wudfhuGdwd = qlo
            hqg
        hqg
    hqg,
})

orfdo rwhuWde = Zlqgrz:FuhdwhWde("rwurv üî©", qlo)
orfdo Vhfwlrq = rwhuWde:FuhdwhVhfwlrq("ghvwurb‚ùå")

orfdo Exwwrq = rwhuWde:FuhdwhExwwrq({
   Qdph = "ghvwuxlu",
   Fdooedfn = ixqfwlrq()
   Udbilhog:Ghvwurb()
   hqg,
})

orfdo iduWde = Zlqgrz:FuhdwhWde("idup üåæ", qlo)
orfdo Vhfwlrq = iduWde:FuhdwhVhfwlrq("iduphr üë®‚Äçüåæ")

orfdo Sodbhuv = jdph:JhwVhuylfh("Sodbhuv")
orfdo UxqVhuylfh = jdph:JhwVhuylfh("UxqVhuylfh")
orfdo OrfdoSodbhu = Sodbhuv.OrfdoSodbhu

-- Jxdugdu ho mxjdgru vhohfflrqdgr ghvgh ho gursgrzq
orfdo VhohfwhgSodbhu = qlo

-- Gursgrzq sdud hohjlu mxjdgru
orfdo Gursgrzq = iduWde:FuhdwhGursgrzq({
    Qdph = "Vhohfflrqdu Mxjdgru",
    Rswlrqv = (ixqfwlrq()
        orfdo qdphv = {}
        iru _, sou lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
            wdeoh.lqvhuw(qdphv, sou.Qdph)
        hqg
        uhwxuq qdphv
    hqg)(),
    FxuuhqwRswlrq = {},
    PxowlsohRswlrqv = idovh,
    Iodj = "SodbhuGursgrzq",
    Fdooedfn = ixqfwlrq(Rswlrqv)
        VhohfwhgSodbhu = Rswlrqv[1] ru qlo
    hqg,
})

-- Dfwxdolcdu olvwd gh mxjdgruhv glq√°plfdphqwh
Sodbhuv.SodbhuDgghg:Frqqhfw(ixqfwlrq()
    orfdo qdphv = {}
    iru _, sou lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
        wdeoh.lqvhuw(qdphv, sou.Qdph)
    hqg
    Gursgrzq:VhwRswlrqv(qdphv)
hqg)

Sodbhuv.SodbhuUhprylqj:Frqqhfw(ixqfwlrq(sodbhu)
    orfdo qdphv = {}
    iru _, sou lq lsdluv(Sodbhuv:JhwSodbhuv()) gr
        wdeoh.lqvhuw(qdphv, sou.Qdph)
    hqg
    Gursgrzq:VhwRswlrqv(qdphv)

    li VhohfwhgSodbhu == sodbhu.Qdph wkhq
        VhohfwhgSodbhu = qlo
    hqg
hqg)

-- Wrjjoh sdud vhjxlu do mxjdgru
orfdo IroorzFrqqhfwlrq = qlo
orfdo VdyhgFIudph = qlo

orfdo Wrjjoh = iduWde:FuhdwhWrjjoh({
    Qdph = "Vhjxlu Mxjdgru",
    FxuuhqwYdoxh = idovh,
    Iodj = "IroorzWrjjoh",
    Fdooedfn = ixqfwlrq(Ydoxh)
        orfdo fkdudfwhu = OrfdoSodbhu.Fkdudfwhu ru OrfdoSodbhu.FkdudfwhuDgghg:Zdlw()
        orfdo urrw = fkdudfwhu:ZdlwIruFklog("KxpdqrlgUrrwSduw")

        li Ydoxh wkhq
            -- Jxdugdu od srvlfl√≥q dfwxdo dqwhv gh vhjxlu
            VdyhgFIudph = urrw.FIudph

            -- Frqhfwdu orrs sdud whohwudqvsruwduvh ghwu√°v gho mxjdgru vhohfflrqdgr
            IroorzFrqqhfwlrq = UxqVhuylfh.UhqghuVwhsshg:Frqqhfw(ixqfwlrq()
                li VhohfwhgSodbhu wkhq
                    orfdo wdujhw = Sodbhuv:IlqgIluvwFklog(VhohfwhgSodbhu)
                    li wdujhw dqg wdujhw.Fkdudfwhu dqg wdujhw.Fkdudfwhu:IlqgIluvwFklog("KxpdqrlgUrrwSduw") wkhq
                        orfdo wdujhwUrrw = wdujhw.Fkdudfwhu.KxpdqrlgUrrwSduw
                        -- Srvlfl√≥q ghwu√°v gho mxjdgru (hmhpsor: -3 vwxgv hq C)
                        orfdo ehklqgFIudph = wdujhwUrrw.FIudph * FIudph.qhz(0, 0, 3)
                        urrw.FIudph = ehklqgFIudph
                    hqg
                hqg
            hqg)
        hovh
            -- Ghvdfwlydu: yroyhu d od srvlfl√≥q ruljlqdo
            li IroorzFrqqhfwlrq wkhq
                IroorzFrqqhfwlrq:Glvfrqqhfw()
                IroorzFrqqhfwlrq = qlo
            hqg
            li VdyhgFIudph wkhq
                urrw.FIudph = VdyhgFIudph
                VdyhgFIudph = qlo
            hqg
        hqg
    hqg,
})

orfdo Vhfwlrq = iduWde:FuhdwhVhfwlrq("dxwr-folfn üëÜ")

orfdo sodbhu = jdph:JhwVhuylfh("Sodbhuv").OrfdoSodbhu
orfdo UxqVhuylfh = jdph:JhwVhuylfh("UxqVhuylfh")

-- Hvwdgr gho wrjjoh
orfdo WrjjohFrqqhfwlrq = qlo

orfdo Wrjjoh = iduWde:FuhdwhWrjjoh({
   Qdph = "Dxwr-folfn",
   FxuuhqwYdoxh = idovh,
   Iodj = "DxwrKlwWrjjoh",
   Fdooedfn = ixqfwlrq(Ydoxh)
      li Ydoxh wkhq
         -- Dfwlydu: frqhfwdu ho exfoh
         WrjjohFrqqhfwlrq = UxqVhuylfh.UhqghuVwhsshg:Frqqhfw(ixqfwlrq()
            orfdo s = jdph.Sodbhuv:JhwSodbhuv()
            iru l = 2, #s gr
                orfdo y = s[l].Fkdudfwhu
                li y dqg y:IlqgIluvwFklog("Kxpdqrlg") dqg y.Kxpdqrlg.Khdowk > 0 dqg y:IlqgIluvwFklog("KxpdqrlgUrrwSduw") wkhq
                    orfdo wrro = sodbhu.Fkdudfwhu dqg sodbhu.Fkdudfwhu:IlqgIluvwFklogRiFodvv("Wrro")
                    li wrro dqg wrro:IlqgIluvwFklog("Kdqgoh") wkhq
                        wrro:Dfwlydwh()
                        iru _, sduw lq qhaw, y:JhwFkloguhq() gr
                            li sduw:LvD("EdvhSduw") wkhq
                                iluhwrxfklqwhuhvw(wrro.Kdqgoh, sduw, 0)
                                iluhwrxfklqwhuhvw(wrro.Kdqgoh, sduw, 1)
                            hqg
                        hqg
                    hqg
                hqg
            hqg
         hqg)
      hovh
         -- Ghvdfwlydu: ghvfrqhfwdu ho exfoh
         li WrjjohFrqqhfwlrq wkhq
            WrjjohFrqqhfwlrq:Glvfrqqhfw()
            WrjjohFrqqhfwlrq = qlo
         hqg
      hqg
   hqg,
})
]]

-- Caesar transform (bytes ASCII)
local function caesar_transform(text, shift)
    if not text or text == "" then return "" end
    local s = ((shift % 26) + 26) % 26
    local out = {}
    local insert = table.insert
    for i = 1, #text do
        local b = text:byte(i)
        if b >= 65 and b <= 90 then -- A-Z
            insert(out, string.char(65 + ((b - 65 + s) % 26)))
        elseif b >= 97 and b <= 122 then -- a-z
            insert(out, string.char(97 + ((b - 97 + s) % 26)))
        else
            insert(out, string.char(b))
        end
    end
    return table.concat(out)
end

local function caesar_decrypt(text, shift) return caesar_transform(text, -(shift or SHIFT)) end

-- Helpers de diagn√≥stico
local function hex_bytes(str, n)
    n = n or #str
    local parts = {}
    for i = 1, math.min(n, #str) do
        parts[#parts+1] = string.format("%02X", str:byte(i))
    end
    return table.concat(parts, " ")
end

local function first_n_chars(str, n)
    n = n or 200
    if #str <= n then return str end
    return str:sub(1, n) .. "...(truncado)"
end

-- Limpieza: quitar BOM UTF-8 si existe
local function strip_bom(s)
    if #s >= 3 and s:byte(1) == 0xEF and s:byte(2) == 0xBB and s:byte(3) == 0xBF then
        return s:sub(4)
    end
    return s
end

-- Normalizar CRLF -> LF y eliminar caracteres de control iniciales
local function normalize(s)
    s = s:gsub("\r\n", "\n")
    -- quitar caracteres de control al inicio (excepto tab/newline si los quieres mantener)
    s = s:gsub("^%z+", "") -- elimina bytes nulos al inicio si hubieran
    -- eliminar caracteres invisibles comunes al inicio (BOM etc) con strip_bom
    s = strip_bom(s)
    -- tambi√©n quitar espacios en blanco al inicio
    s = s:gsub("^%s+", "")
    return s
end

-- MAIN
local ok, decrypted = pcall(caesar_decrypt, CIPHER_TEXT, SHIFT)
if not ok then
    error("Error durante la descifrado: " .. tostring(decrypted))
end

decrypted = normalize(decrypted)

-- Intentar cargar
local loader = load or loadstring
if not loader then error("No hay 'load' ni 'loadstring' en este entorno.") end

local fn, load_err = loader(decrypted)
if not fn then
    -- diagn√≥stico completo
    local snippet = first_n_chars(decrypted, 400)
    local hexstart = hex_bytes(decrypted, 32)
    -- Mensaje claro para ti / para pegar aqu√≠
    local msg = {}
    msg[#msg+1] = "=== Error al cargar el c√≥digo descifrado ==="
    msg[#msg+1] = "Error del loader: " .. tostring(load_err)
    msg[#msg+1] = "Primeros caracteres (texto):"
    msg[#msg+1] = snippet
    msg[#msg+1] = "Primeros bytes (hex, 32):"
    msg[#msg+1] = hexstart
    msg[#msg+1] = "Si quieres, pega aqu√≠ el bloque de 'Primeros caracteres' para que lo revisemos."
    -- Imprimir todo
    for i=1,#msg do print(msg[i]) end
    error("No se pudo cargar el c√≥digo descifrado. Revisa el diagn√≥stico impreso arriba.")
end

local exec_ok, exec_err = pcall(fn)
if not exec_ok then
    error("Error al ejecutar el c√≥digo descifrado: " .. tostring(exec_err))
end

print("C√≥digo descifrado ejecutado correctamente.")
